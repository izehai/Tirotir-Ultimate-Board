<!doctype html>
<html lang="en" dir="ltr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Tirotir Ultimate Board v2.2.0 — View</title>
  <link rel="manifest" href="/manifest.json">
  <link rel="stylesheet" href="/static/style.css">
  <script src="/socket.io/socket.io.js"></script>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <h1>Viewer — Ultimate Board v2.2.0</h1>
        <div class="muted">Live text & drawing • download files</div>
      </div>
      <div class="bar">
        <input id="room" placeholder="Room (main)" />
        <button id="btnConnect" class="primary">Connect</button>
        <button id="btnCopy" class="primary">Copy text</button>
        <button id="btnPasteV" class="primary">Paste</button>
        <span id="stamp" class="badge">—</span>
      </div>
    </header>

    <div class="brand">AI Academy • <strong>tirotir.ir</strong></div>

    <section><div class="viewer" id="viewer">Waiting for connection…</div></section>

    <section style="margin-top:16px">
      <canvas id="board" style="width:100%; max-width:100%; height:auto; aspect-ratio: 12 / 7;"></canvas>
      <div class="muted">The teacher’s canvas renders live.</div>
      <div style="margin-top:8px"><a id="dlCanvas" target="_blank" class="badge" href="#">Download latest saved PNG</a></div>
    </section>

    <section style="margin-top:16px">
      <h3>Class files</h3>
      <div id="files" class="files"></div>
    </section>
  </div>

<script>
  (function(){
    // Optional: disable Service Worker via ?nosw=1
    try{
      var usp=new URLSearchParams(location.search);
      if(usp.get('nosw')==='1' && 'serviceWorker' in navigator){
        navigator.serviceWorker.getRegistrations().then(function(rs){
          for(var i=0;i<rs.length;i++){ rs[i].unregister(); }
          localStorage.setItem('ub_nosw_done','1'); location.replace(location.pathname);
        });
      } else if(localStorage.getItem('ub_nosw_done')==='1'){ localStorage.removeItem('ub_nosw_done'); }
    }catch(e){}

    function $(s){ return document.querySelector(s); }
    var room=(new URLSearchParams(location.search)).get('room')||localStorage.getItem('ub_room_view')||'main';
    $('#room').value=room;
    var stamp=$('#stamp'), viewer=$('#viewer'), board=$('#board'), ctx=board.getContext('2d'), dlCanvas=$('#dlCanvas'), filesDiv=$('#files');
    var strokes=[];

    function resizeCanvas(){
      var rect=board.getBoundingClientRect();
      var dpr=window.devicePixelRatio||1;
      var needW=Math.max(1, Math.round(rect.width*dpr));
      var needH=Math.max(1, Math.round(rect.height*dpr));
      if(board.width!==needW || board.height!==needH){ board.width=needW; board.height=needH; }
      ctx.setTransform(dpr,0,0,dpr,0,0);
      redrawAll();
    }
    window.addEventListener('load', function(){ if (window.requestAnimationFrame) requestAnimationFrame(resizeCanvas); else resizeCanvas(); });
    window.addEventListener('resize', resizeCanvas); resizeCanvas();

    function clearCanvas(){
      ctx.fillStyle='#111b2f'; ctx.fillRect(0,0,board.width,board.height);
      // watermark
      ctx.save(); ctx.globalAlpha=0.06; ctx.fillStyle='#ffffff'; ctx.textAlign='center';
      try{ ctx.font='bold 42px Tahoma, Arial, sans-serif'; }catch(e){}
      ctx.translate(board.width/2, board.height/2); ctx.rotate(-Math.PI/8);
      ctx.fillText('AI Academy', 0, 0); ctx.fillText('tirotir.ir', 0, 50);
      ctx.restore();
    }
    function applyStroke(s){
      ctx.save();
      if(s.tool==='eraser'){ ctx.globalCompositeOperation='destination-out'; ctx.strokeStyle='rgba(0,0,0,1)'; }
      else if(s.tool==='highlighter'){ ctx.globalAlpha=s.opacity||0.3; ctx.strokeStyle=s.color||'#ffff00'; }
      else { ctx.strokeStyle=s.color||'#fff'; }
      ctx.lineWidth=s.size||3; ctx.lineCap='round';
      if(s.shape==='line'&&s.from&&s.to){ ctx.beginPath(); ctx.moveTo(s.from.x,s.from.y); ctx.lineTo(s.to.x,s.to.y); ctx.stroke(); }
      else if(s.shape==='rect'&&s.rect){ ctx.lineJoin='round'; ctx.strokeRect(s.rect.x,s.rect.y,s.rect.w,s.rect.h); }
      else if(s.points&&s.points.length){ ctx.beginPath(); ctx.moveTo(s.points[0].x,s.points[0].y); for(var i=1;i<s.points.length;i++){ ctx.lineTo(s.points[i].x,s.points[i].y);} ctx.stroke(); }
      ctx.restore();
    }
    function redrawAll(){ clearCanvas(); for(var i=0;i<strokes.length;i++) applyStroke(strokes[i]); }

    var socket=null;
    function connect(){
      room=($('#room').value||'main').trim(); localStorage.setItem('ub_room_view', room);
      console.log('connecting viewer to room', room);
      socket=io({ auth:{ room: room, role: 'viewer' } });
      socket.on('connect', function(){ stamp.textContent='Connected'; });
      socket.on('disconnect', function(){ stamp.textContent='Disconnected'; });
      socket.on('init', function(st){ viewer.textContent=st.text||''; strokes=st.strokes||[]; redrawAll(); renderFiles(st.files||[]); dlCanvas.setAttribute('href','/snapshot/'+encodeURIComponent(room)+'/canvas.png'); try{ if(window.requestAnimationFrame) requestAnimationFrame(resizeCanvas); else resizeCanvas(); }catch(e){} });
      socket.on('update_text', function(st){ console.log('update_text received, length=', (st && st.text ? st.text.length : 0)); viewer.textContent = st.text || ''; });
      socket.on('draw_event', function(s){ strokes.push(s); applyStroke(s); });
      socket.on('draw_segment', function(seg){ try{ applyStroke(seg); }catch(e){} });
      socket.on('clear_canvas', function(){ strokes=[]; redrawAll(); });
      socket.on('undo', function(){ strokes.pop(); redrawAll(); });
      socket.on('redo', function(s){ if(s){ strokes.push(s); applyStroke(s); } });
      socket.emit('request_full');
      try{ window.__fullTimer && clearInterval(window.__fullTimer); window.__fullTimer = setInterval(function(){ if(socket && socket.connected){ socket.emit('request_full'); } }, 15000); }catch(e){}
    }
    $('#btnConnect').onclick=connect;

    function renderFiles(list){
      if(!list || !list.length){ filesDiv.innerHTML='<div class="muted">No files yet.</div>'; return; }
      var html=''; for (var i=0;i<list.length;i++){ var f=list[i]; var kb=Math.round((f.size||0)/1024); html+='<div><a href="'+f.url+'" target="_blank">'+f.name+'</a> <span class="muted">('+kb+' KB)</span></div>'; }
      filesDiv.innerHTML=html;
    }

    $('#btnCopy').onclick=function(){
      try{ navigator.clipboard.writeText(viewer.textContent); }
      catch(e){
        var sel=window.getSelection(); var range=document.createRange();
        range.selectNodeContents(viewer); sel.removeAllRanges(); sel.addRange(range);
        document.execCommand('copy'); sel.removeAllRanges();
      }
    };

    // Paste (viewer -> server)
    function sendPastedText(t){
      if(!t) return;
      if (socket) socket.emit('paste_text', { text: t });
    }
    document.addEventListener('paste', function(e){
      try{
        var t='';
        if (e.clipboardData && e.clipboardData.getData) t=e.clipboardData.getData('text/plain');
        else if (window.clipboardData && window.clipboardData.getData) t=window.clipboardData.getData('Text');
        if (t){ e.preventDefault(); sendPastedText(t); }
      }catch(err){}
    });
    $('#btnPasteV').onclick=function(){
      try{
        if (navigator.clipboard && navigator.clipboard.readText){
          navigator.clipboard.readText().then(function(t){ sendPastedText(t); }, function(){ alert('Paste requires Ctrl+V or clipboard permission.'); });
        } else { alert('Paste requires Ctrl+V.'); }
      }catch(e){ alert('Paste requires Ctrl+V.'); }
    };

    clearCanvas();
  })();
</script>
</body>
</html>
